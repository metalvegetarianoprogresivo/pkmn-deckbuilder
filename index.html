<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Deckbuilder Pro ‚Ä¢ Pok√©mon TCG</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #d946ef;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --dark: #0f0a1a;
            --card-bg: rgba(15, 10, 26, 0.95);
            --border: rgba(217, 70, 239, 0.2);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, #0f0a1a 0%, #1a0b2e 50%, #0f0a1a 100%);
            color: #fff;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(217, 70, 239, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInDown 0.8s ease-out;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            font-weight: 400;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--success);
            border-radius: 20px;
            font-size: 0.875rem;
            color: var(--success);
            margin-top: 0.5rem;
        }

        .deck-selector {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .deck-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .deck-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .deck-card:hover {
            border-color: var(--primary);
            background: rgba(217, 70, 239, 0.1);
            transform: translateY(-4px);
        }

        .deck-card.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(217, 70, 239, 0.2), rgba(139, 92, 246, 0.2));
            box-shadow: 0 8px 32px rgba(217, 70, 239, 0.3);
        }

        .deck-card-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .deck-card-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .deck-card-meta {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 450px;
            gap: 2rem;
            animation: fadeIn 1s ease-out 0.4s backwards;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .deck-builder {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .add-card-section {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 1rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(0, 0, 0, 0.4);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 80px;
            gap: 1rem;
        }

        .card-category {
            margin-bottom: 2rem;
        }

        .category-header {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-count {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .card-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(217, 70, 239, 0.1);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .card-item:hover {
            background: rgba(217, 70, 239, 0.1);
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .card-controls {
            display: flex;
            gap: 0.5rem;
        }

        .card-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .card-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .card-btn.delete {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--danger);
        }

        .card-btn.delete:hover {
            background: var(--danger);
        }

        .card-count-display {
            min-width: 24px;
            text-align: center;
            font-weight: 700;
            color: var(--primary);
        }

        .card-name {
            flex: 1;
            font-weight: 500;
        }

        .card-set {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .deck-summary {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 2rem;
        }

        .deck-count {
            text-align: center;
            margin-bottom: 2rem;
        }

        .deck-count-number {
            font-size: 4rem;
            font-weight: 900;
            font-family: 'Playfair Display', serif;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
        }

        .deck-count-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 0.5rem;
        }

        .deck-count-number.complete {
            background: linear-gradient(135deg, var(--success), #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .deck-breakdown {
            display: grid;
            gap: 0.75rem;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .breakdown-label {
            color: rgba(255, 255, 255, 0.7);
        }

        .breakdown-value {
            font-weight: 700;
            color: var(--primary);
        }

        .action-buttons {
            display: grid;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            display: block;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 16px rgba(217, 70, 239, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(217, 70, 239, 0.6);
        }

        .btn-secondary {
            background: rgba(217, 70, 239, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-secondary:hover {
            background: rgba(217, 70, 239, 0.2);
        }

        .matchup-optimizer {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            margin-top: 2rem;
        }

        .matchup-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .matchup-btn {
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-align: center;
        }

        .matchup-btn:hover {
            background: rgba(217, 70, 239, 0.1);
            border-color: var(--primary);
        }

        .matchup-btn.selected {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: var(--primary);
            box-shadow: 0 4px 16px rgba(217, 70, 239, 0.3);
        }

        .recommendations {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .recommendation-item {
            padding: 1rem;
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid var(--secondary);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .recommendation-item.tech {
            background: rgba(16, 185, 129, 0.1);
            border-left-color: var(--success);
        }

        .recommendation-item.remove {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: var(--danger);
        }

        .recommendation-header {
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .recommendation-text {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
        }

        .playtesting-section {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            margin-top: 2rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--primary);
            transform: rotate(90deg);
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--card-bg);
            border: 1px solid var(--success);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            color: white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            transform: translateY(150%);
            transition: transform 0.3s ease;
            z-index: 2000;
            max-width: 300px;
        }

        .toast.show {
            transform: translateY(0);
        }

        .toast.error {
            border-color: var(--danger);
        }

        .toast.warning {
            border-color: var(--warning);
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            h1 {
                font-size: 2rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö° Universal Deckbuilder Pro</h1>
            <p class="subtitle">Pok√©mon TCG ‚Ä¢ Formato Standard 2026</p>
            <div class="badge">üîÑ Auto-guardado ‚Ä¢ üé≤ Playtesting ‚Ä¢ üéØ Matchup Optimizer</div>
        </header>

        <div class="deck-selector">
            <h2 class="section-title">üìã Selecciona o Crea tu Deck</h2>
            <div class="deck-grid" id="deckSelector">
                <div class="deck-card" data-deck="custom">
                    <div class="deck-card-icon">‚ûï</div>
                    <div class="deck-card-name">Deck Personalizado</div>
                    <div class="deck-card-meta">Construye desde cero</div>
                </div>
                <div class="deck-card" data-deck="gardevoir">
                    <div class="deck-card-icon">üîÆ</div>
                    <div class="deck-card-name">Gardevoir ex</div>
                    <div class="deck-card-meta">Tier 1 ‚Ä¢ 16.4% meta</div>
                </div>
                <div class="deck-card" data-deck="dragapult">
                    <div class="deck-card-icon">üëª</div>
                    <div class="deck-card-name">Dragapult ex</div>
                    <div class="deck-card-meta">Tier 1 ‚Ä¢ 23.4% meta</div>
                </div>
                <div class="deck-card" data-deck="gholdengo">
                    <div class="deck-card-icon">üí∞</div>
                    <div class="deck-card-name">Gholdengo ex</div>
                    <div class="deck-card-meta">Tier 1 ‚Ä¢ 18.5% meta</div>
                </div>
                <div class="deck-card" data-deck="charizard">
                    <div class="deck-card-icon">üî•</div>
                    <div class="deck-card-name">Charizard ex</div>
                    <div class="deck-card-meta">Tier 1 ‚Ä¢ 15.1% meta</div>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div>
                <div class="deck-builder">
                    <h2 class="section-title">üÉè Constructor de Deck</h2>
                    
                    <div class="add-card-section">
                        <h3 style="font-size: 1rem; margin-bottom: 1rem; color: var(--accent);">‚ûï Agregar Carta</h3>
                        <div class="form-row">
                            <div class="form-group" style="margin: 0;">
                                <input type="text" class="form-input" id="cardName" placeholder="Nombre de la carta">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <input type="text" class="form-input" id="cardSet" placeholder="Set (ej: MEG 58)">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <input type="number" class="form-input" id="cardCount" placeholder="1-4" min="1" max="4" value="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <select class="form-select" id="cardType">
                                <option value="pokemon">Pok√©mon</option>
                                <option value="trainer">Trainer</option>
                                <option value="energy">Energy</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="addCard()">‚ûï Agregar Carta</button>
                    </div>

                    <div id="deckBuilder">
                        <div style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.4);">
                            Selecciona un deck o agrega cartas manualmente
                        </div>
                    </div>
                </div>

                <div class="matchup-optimizer">
                    <h2 class="section-title">üéØ Optimizador de Matchups</h2>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 1.5rem; font-size: 0.9rem;">
                        Selecciona o busca cualquier deck del meta para recibir recomendaciones espec√≠ficas
                    </p>
                    
                    <div style="background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1rem; margin-bottom: 1rem; color: var(--accent);">üîó Importar desde Limitless TCG</h3>
                        <p style="font-size: 0.875rem; color: rgba(255,255,255,0.6); margin-bottom: 1rem;">
                            Pega una URL de Limitless (ej: https://limitlesstcg.com/decks/list/12345)
                        </p>
                        <div style="position: relative;">
                            <input 
                                type="text" 
                                class="form-input" 
                                id="limitlessUrlInput" 
                                placeholder="https://limitlesstcg.com/decks/list/12345"
                                style="padding-right: 3rem;"
                            >
                            <button 
                                onclick="importFromLimitless()" 
                                class="btn btn-primary" 
                                style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); padding: 0.5rem 1rem; font-size: 0.875rem;">
                                üì•
                            </button>
                        </div>
                        <div id="limitlessImportStatus" style="margin-top: 1rem;"></div>
                    </div>

                    <div style="background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1rem; margin-bottom: 1rem; color: var(--accent);">üîç Buscar Deck</h3>
                        <div style="position: relative;">
                            <input 
                                type="text" 
                                class="form-input" 
                                id="deckSearchInput" 
                                placeholder="Busca cualquier deck (ej: Raging Bolt, Pidgeot, Roaring Moon...)"
                                style="padding-right: 3rem;"
                            >
                            <button 
                                onclick="searchDeck()" 
                                class="btn btn-primary" 
                                style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); padding: 0.5rem 1rem; font-size: 0.875rem;">
                                üîç
                            </button>
                        </div>
                        <div id="deckSearchResults" style="margin-top: 1rem;"></div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <h3 style="font-size: 1rem; margin-bottom: 0.75rem; color: var(--accent);">‚ö° Decks Populares</h3>
                    </div>
                    
                    <div class="matchup-selector">
                        <button class="matchup-btn" data-matchup="dragapult">üëª Dragapult</button>
                        <button class="matchup-btn" data-matchup="gholdengo">üí∞ Gholdengo</button>
                        <button class="matchup-btn" data-matchup="charizard">üî• Charizard</button>
                        <button class="matchup-btn" data-matchup="mirror">ü™û Mirror</button>
                        <button class="matchup-btn" data-matchup="grimmsnarl">üëπ Grimmsnarl</button>
                        <button class="matchup-btn" data-matchup="aggro">‚ö° Meta Agresivo</button>
                        <button class="matchup-btn" data-matchup="ragingbolt">‚ö° Raging Bolt</button>
                        <button class="matchup-btn" data-matchup="roaringmoon">üåë Roaring Moon</button>
                        <button class="matchup-btn" data-matchup="ancientbox">üì¶ Ancient Box</button>
                    </div>

                    <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(59,130,246,0.1); border: 1px solid var(--info); border-radius: 8px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="font-weight: 600; color: var(--info);">üìä √öltima Actualizaci√≥n de Stats</span>
                            <button class="btn btn-secondary" onclick="updateMetaStats()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                üîÑ Actualizar Ahora
                            </button>
                        </div>
                        <div style="font-size: 0.875rem; color: rgba(255,255,255,0.7);" id="lastStatsUpdate">
                            Cargando...
                        </div>
                    </div>

                    <div class="recommendations" id="recommendations">
                        <div style="text-align: center; color: rgba(255,255,255,0.4); padding: 2rem;">
                            Selecciona o busca un matchup para ver recomendaciones
                        </div>
                    </div>

                    <div id="selectedMatchupInfo" style="display: none; margin-top: 1.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                        <h3 style="font-size: 1rem; color: var(--primary); margin-bottom: 1rem;">üìà Info del Matchup</h3>
                        <div id="matchupInfoContent"></div>
                    </div>
                </div>

                <div class="playtesting-section">
                    <h2 class="section-title">üé≤ Sistema de Playtesting</h2>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 1.5rem; font-size: 0.9rem;">
                        Prueba la consistencia de tu deck simulando manos iniciales
                    </p>
                    
                    <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                        <button class="btn btn-primary" onclick="drawHand()">
                            üé¥ Robar Mano Inicial (7 cartas)
                        </button>
                        <button class="btn btn-secondary" onclick="mulligan()" id="mulliganBtn" disabled>
                            üîÑ Mulligan
                        </button>
                    </div>

                    <div id="handDisplay" style="display: none;">
                        <div style="background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3 style="font-size: 1.1rem; color: var(--primary);">Tu Mano</h3>
                                <span id="handCount" style="font-size: 0.9rem; color: rgba(255,255,255,0.5);"></span>
                            </div>
                            <div id="handCards" style="display: grid; gap: 0.5rem; margin-bottom: 1rem;"></div>
                            
                            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                                <h4 style="font-size: 0.9rem; color: var(--accent); margin-bottom: 0.75rem;">An√°lisis de Mano</h4>
                                <div id="handAnalysis"></div>
                            </div>
                        </div>

                        <div style="margin-top: 1.5rem; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                            <h3 style="font-size: 1.1rem; color: var(--primary); margin-bottom: 1rem;">Estad√≠sticas de Testing</h3>
                            <div id="testingStats"></div>
                            <button class="btn btn-secondary" onclick="resetTestingStats()" style="margin-top: 1rem;">
                                üóëÔ∏è Reiniciar Estad√≠sticas
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="deck-summary">
                    <div class="deck-count">
                        <div class="deck-count-number" id="totalCards">0</div>
                        <div class="deck-count-label">/ 60 cartas</div>
                    </div>

                    <div class="deck-breakdown">
                        <div class="breakdown-item">
                            <span class="breakdown-label">Pok√©mon</span>
                            <span class="breakdown-value" id="pokemonCount">0</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Trainers</span>
                            <span class="breakdown-value" id="trainerCount">0</span>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">Energy</span>
                            <span class="breakdown-value" id="energyCount">0</span>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="exportDeck()">
                            üìã Exportar Decklist
                        </button>
                        <button class="btn btn-secondary" onclick="saveDeck()">
                            üíæ Guardar Deck
                        </button>
                        <button class="btn btn-secondary" onclick="loadDeck()">
                            üìÇ Cargar Deck
                        </button>
                        <button class="btn btn-secondary" onclick="resetDeck()">
                            üîÑ Limpiar Deck
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('exportModal')">√ó</button>
            <h2 class="section-title">üìã Exportar Decklist</h2>
            <div style="background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; font-family: 'Courier New', monospace; font-size: 0.9rem; white-space: pre-wrap; max-height: 400px; overflow-y: auto; margin: 1rem 0;" id="decklistText"></div>
            <button class="btn btn-primary" onclick="copyDecklist()">
                üìÑ Copiar al Portapapeles
            </button>
        </div>
    </div>

    <!-- Save Deck Modal -->
    <div id="saveDeckModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('saveDeckModal')">√ó</button>
            <h2 class="section-title">üíæ Guardar Deck</h2>
            <div class="form-group">
                <label class="form-label">Nombre del Deck</label>
                <input type="text" class="form-input" id="deckNameInput" placeholder="Mi Deck Personalizado">
            </div>
            <button class="btn btn-primary" onclick="confirmSaveDeck()">
                üíæ Guardar
            </button>
            
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                <h3 style="font-size: 1rem; margin-bottom: 1rem; color: var(--accent);">Decks Guardados</h3>
                <div id="savedDecksList"></div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">
        <span id="toastMessage"></span>
    </div>

    <script>
        // Preset decks data
        const presetDecks = {
            gardevoir: {
                name: "Gardevoir ex Standard",
                pokemon: [
                    { name: "Ralts", set: "MEG 58", count: 3 },
                    { name: "Kirlia", set: "MEG 59", count: 2 },
                    { name: "Gardevoir ex", set: "SVI 86", count: 2 },
                    { name: "Munkidori", set: "TWM 95", count: 3 },
                    { name: "Scream Tail", set: "PAR 86", count: 1 },
                    { name: "Frillish", set: "WHT 44", count: 1 },
                    { name: "Mew ex", set: "MEW 151", count: 1 },
                    { name: "Lillie's Clefairy ex", set: "JTG 56", count: 1 },
                    { name: "Fezandipiti ex", set: "SFA 38", count: 1 }
                ],
                trainers: [
                    { name: "Iono", set: "PAL 185", count: 4 },
                    { name: "Lillie's Determination", set: "MEG 119", count: 4 },
                    { name: "Arven", set: "OBF 186", count: 2 },
                    { name: "Professor Turo's Scenario", set: "PAR 171", count: 1 },
                    { name: "Ultra Ball", set: "MEG 131", count: 4 },
                    { name: "Earthen Vessel", set: "PAR 163", count: 3 },
                    { name: "Nest Ball", set: "SVI 181", count: 2 },
                    { name: "Rare Candy", set: "MEG 125", count: 2 },
                    { name: "Night Stretcher", set: "SFA 61", count: 2 },
                    { name: "Counter Catcher", set: "PAR 160", count: 2 },
                    { name: "Technical Machine: Evolution", set: "PAR 178", count: 2 },
                    { name: "Super Rod", set: "PAL 188", count: 1 },
                    { name: "Secret Box", set: "TWM 163", count: 1 },
                    { name: "Bravery Charm", set: "PAL 173", count: 1 },
                    { name: "Luxurious Cape", set: "PAR 166", count: 1 },
                    { name: "Artazon", set: "PAL 171", count: 2 }
                ],
                energy: [
                    { name: "Psychic Energy", set: "MEE 5", count: 8 },
                    { name: "Darkness Energy", set: "MEE 7", count: 3 }
                ]
            },
            dragapult: {
                name: "Dragapult ex",
                pokemon: [
                    { name: "Dreepy", set: "TWM 129", count: 4 },
                    { name: "Drakloak", set: "TWM 130", count: 2 },
                    { name: "Dragapult ex", set: "TWM 130", count: 3 },
                    { name: "Pidgey", set: "OBF 162", count: 2 },
                    { name: "Pidgeot ex", set: "OBF 164", count: 2 },
                    { name: "Manaphy", set: "BRS 41", count: 1 },
                    { name: "Radiant Greninja", set: "ASR 46", count: 1 }
                ],
                trainers: [
                    { name: "Iono", set: "PAL 185", count: 4 },
                    { name: "Boss's Orders", set: "PAL 172", count: 2 },
                    { name: "Professor's Research", set: "SVI 189", count: 3 },
                    { name: "Ultra Ball", set: "SVI 196", count: 4 },
                    { name: "Rare Candy", set: "SVI 191", count: 3 },
                    { name: "Nest Ball", set: "SVI 181", count: 3 },
                    { name: "Counter Catcher", set: "PAR 160", count: 2 },
                    { name: "Super Rod", set: "PAL 188", count: 1 },
                    { name: "Beach Court", set: "SVI 167", count: 2 }
                ],
                energy: [
                    { name: "Psychic Energy", set: "SVI 216", count: 8 },
                    { name: "Reversal Energy", set: "PAL 192", count: 3 }
                ]
            },
            gholdengo: {
                name: "Gholdengo ex",
                pokemon: [
                    { name: "Gimmighoul", set: "PAR 87", count: 4 },
                    { name: "Gholdengo ex", set: "PAR 139", count: 3 },
                    { name: "Genesect V", set: "FST 185", count: 2 },
                    { name: "Manaphy", set: "BRS 41", count: 1 }
                ],
                trainers: [
                    { name: "Iono", set: "PAL 185", count: 4 },
                    { name: "Professor's Research", set: "SVI 189", count: 3 },
                    { name: "Boss's Orders", set: "PAL 172", count: 2 },
                    { name: "Ultra Ball", set: "SVI 196", count: 4 },
                    { name: "Superior Energy Retrieval", set: "PAL 189", count: 4 },
                    { name: "Counter Catcher", set: "PAR 160", count: 2 },
                    { name: "Super Rod", set: "PAL 188", count: 1 },
                    { name: "Beach Court", set: "SVI 167", count: 3 }
                ],
                energy: [
                    { name: "Psychic Energy", set: "SVI 216", count: 12 }
                ]
            },
            charizard: {
                name: "Charizard ex",
                pokemon: [
                    { name: "Charmander", set: "OBF 26", count: 4 },
                    { name: "Charmeleon", set: "OBF 27", count: 2 },
                    { name: "Charizard ex", set: "OBF 125", count: 3 },
                    { name: "Pidgey", set: "OBF 162", count: 2 },
                    { name: "Pidgeot ex", set: "OBF 164", count: 2 },
                    { name: "Manaphy", set: "BRS 41", count: 1 }
                ],
                trainers: [
                    { name: "Iono", set: "PAL 185", count: 4 },
                    { name: "Professor's Research", set: "SVI 189", count: 3 },
                    { name: "Boss's Orders", set: "PAL 172", count: 2 },
                    { name: "Ultra Ball", set: "SVI 196", count: 4 },
                    { name: "Rare Candy", set: "SVI 191", count: 3 },
                    { name: "Nest Ball", set: "SVI 181", count: 3 },
                    { name: "Counter Catcher", set: "PAR 160", count: 2 },
                    { name: "Super Rod", set: "PAL 188", count: 1 }
                ],
                energy: [
                    { name: "Fire Energy", set: "SVI 207", count: 11 }
                ]
            }
        };

        // Comprehensive meta decks database (SVI-ASC Format only)
        const metaDecks = [
            // Tier 1
            { name: 'Dragapult ex', icon: 'üëª', tier: 1, share: 23.4, type: 'Control/Spread', key: 'dragapult' },
            { name: 'Gholdengo ex', icon: 'üí∞', tier: 1, share: 18.5, type: 'Control', key: 'gholdengo' },
            { name: 'Gardevoir ex', icon: 'üîÆ', tier: 1, share: 16.4, type: 'Stage 2', key: 'gardevoir' },
            { name: 'Charizard ex', icon: 'üî•', tier: 1, share: 15.1, type: 'Stage 2', key: 'charizard' },
            
            // Tier 2
            { name: "Marnie's Grimmsnarl ex", icon: 'üëπ', tier: 2, share: 5.1, type: 'Aggro', key: 'grimmsnarl' },
            { name: 'Mega Absol Box', icon: 'üåô', tier: 2, share: 3.6, type: 'Toolbox', key: 'absol' },
            { name: 'Raging Bolt ex', icon: '‚ö°', tier: 2, share: 3.2, type: 'Aggro', key: 'ragingbolt' },
            { name: 'Roaring Moon ex', icon: 'üåë', tier: 2, share: 2.5, type: 'Aggro', key: 'roaringmoon' },
            { name: 'Ancient Box', icon: 'üì¶', tier: 2, share: 2.3, type: 'Toolbox', key: 'ancientbox' },
            { name: 'Terapagos ex', icon: 'üê¢', tier: 2, share: 1.9, type: 'Stage 1', key: 'terapagos' },
            
            // Tier 3 / Rogue
            { name: 'Iron Hands ex', icon: 'ü§ñ', tier: 3, share: 1.4, type: 'Aggro', key: 'ironhands' },
            { name: 'Chien-Pao ex', icon: '‚ùÑÔ∏è', tier: 3, share: 1.3, type: 'Aggro', key: 'chienpao' },
            { name: 'Miraidon ex', icon: '‚ö°', tier: 3, share: 1.1, type: 'Spread', key: 'miraidon' },
            { name: 'Snorlax Stall', icon: 'üò¥', tier: 3, share: 0.9, type: 'Mill/Stall', key: 'snorlax' },
            { name: 'Pidgeot ex Control', icon: 'ü¶Ö', tier: 3, share: 0.8, type: 'Control', key: 'pidgeot' },
            { name: 'Flutter Mane', icon: 'üëª', tier: 3, share: 0.7, type: 'Control', key: 'fluttermane' },
            { name: 'Gouging Fire ex', icon: 'üî•', tier: 3, share: 0.6, type: 'Aggro', key: 'gougingfire' },
            { name: 'Walking Wake ex', icon: 'üåä', tier: 3, share: 0.5, type: 'Aggro', key: 'walkingwake' },
            { name: 'Iron Thorns ex', icon: 'ü¶ñ', tier: 3, share: 0.5, type: 'Tank', key: 'ironthorns' },
            { name: 'Dusknoir Mill', icon: 'üíÄ', tier: 3, share: 0.4, type: 'Mill', key: 'dusknoir' },
            { name: 'Lilligant ex', icon: 'üå∫', tier: 3, share: 0.4, type: 'Stage 1', key: 'lilligant' },
            { name: 'Regidrago', icon: 'üê≤', tier: 3, share: 0.3, type: 'Stage 1', key: 'regidrago' },
            { name: 'Espathra ex', icon: 'ü¶ú', tier: 3, share: 0.3, type: 'Stage 1', key: 'espathra' },
        ];

        // Matchup recommendations database
        const matchupRecommendations = {
            gardevoir: {
                dragapult: [
                    { type: 'tech', text: '+1 Technical Machine: Evolution - Acelera tu setup para establecer antes que Dragapult' },
                    { type: 'tech', text: '+1 Budew - Bloquea el bench y limita Phantom Dive' },
                    { type: 'strategy', text: 'Prioriza KO en Dragapult ex antes que en las evoluciones' },
                    { type: 'strategy', text: 'Usa Counter Catcher cuando est√©n por ganar' },
                    { type: 'remove', text: 'Considera -1 Luxurious Cape si ves mucho Dragapult' }
                ],
                gholdengo: [
                    { type: 'tech', text: '+1-2 Frillish (WHT 44) - CR√çTICO: Bloquea Superior Energy Retrieval' },
                    { type: 'tech', text: '+1 Jellicent ex - Oceanic Curse lockea sus Items' },
                    { type: 'strategy', text: 'Usa Munkidori Adrena-Brain para math exacto' },
                    { type: 'strategy', text: 'Counter Catcher para sacar Genesect del Active' },
                    { type: 'remove', text: '-1 Mew ex si esperas mucho Gholdengo' }
                ],
                charizard: [
                    { type: 'warning', text: '‚ö†Ô∏è MATCHUP MUY DIF√çCIL - Weakness x2 a Fire' },
                    { type: 'tech', text: '+1 Scream Tail adicional - Snipe Charcadet temprano' },
                    { type: 'tech', text: '+1 Drifloon - Tech opcional contra Fire' },
                    { type: 'strategy', text: 'Juega EXTREMADAMENTE agresivo - gana antes de setup de Dusknoir' },
                    { type: 'strategy', text: 'Usa Luxurious Cape para sobrevivir un turno extra' }
                ],
                mirror: [
                    { type: 'tech', text: '+1 Jellicent ex - Domina el mirror con Oceanic Curse' },
                    { type: 'tech', text: '+1 TM: Devolution - Counter a Jellicent del oponente' },
                    { type: 'strategy', text: 'Quien establezca primero tiene ventaja significativa' },
                    { type: 'strategy', text: 'Usa Adrena-Brain para math exacto de KOs' },
                    { type: 'strategy', text: 'Guarda Counter Catcher para momentos cr√≠ticos' }
                ],
                grimmsnarl: [
                    { type: 'tech', text: '+1 Bravery Charm adicional - Mant√©n HP alto en Gardevoir' },
                    { type: 'tech', text: '+1 Night Stretcher - Recuperaci√≥n es cr√≠tica' },
                    { type: 'strategy', text: 'Mant√©n HP de Gardevoir >170 HP (evita OHKO de Grimmsnarl)' },
                    { type: 'strategy', text: 'Minimiza bench - N\'s Darmanitan snipea Basics' },
                    { type: 'strategy', text: 'Juega agresivo con Munkidori para presi√≥n temprana' }
                ],
                aggro: [
                    { type: 'tech', text: '+1 Bravery Charm - Sobrevivir es prioridad' },
                    { type: 'tech', text: '+1 Night Stretcher - Recuperaci√≥n constante' },
                    { type: 'tech', text: '+1 Manaphy - Protecci√≥n contra snipe' },
                    { type: 'strategy', text: 'Prioriza establecer m√∫ltiples Gardevoir temprano' },
                    { type: 'remove', text: '-1 Secret Box - Menos √∫til vs aggro' }
                ]
            },
            dragapult: {
                gardevoir: [
                    { type: 'strategy', text: 'Usa Phantom Dive para snipe Basics en bench' },
                    { type: 'strategy', text: 'Fuerza trade favorable con Reversal Energy' },
                    { type: 'tech', text: '+1 Boss\'s Orders para cerrar juegos' }
                ],
                gholdengo: [
                    { type: 'tech', text: '+1 Path to the Peak - Bloquea habilidades' },
                    { type: 'strategy', text: 'Presi√≥n temprana con Phantom Dive' }
                ],
                mirror: [
                    { type: 'tech', text: '+1 Manaphy - Protege tu bench' },
                    { type: 'strategy', text: 'Quien establezca Dragapult primero gana' }
                ]
            },
            gholdengo: {
                gardevoir: [
                    { type: 'strategy', text: 'Usa Superior Energy Retrieval para velocidad' },
                    { type: 'tech', text: '+1 Counter Catcher para control' },
                    { type: 'warning', text: '‚ö†Ô∏è Cuidado con Frillish - bloquea tu estrategia' }
                ],
                dragapult: [
                    { type: 'tech', text: '+1 Manaphy - Protecci√≥n contra Phantom Dive' },
                    { type: 'strategy', text: 'Setup m√∫ltiples Gholdengo r√°pido' }
                ]
            },
            charizard: {
                gardevoir: [
                    { type: 'strategy', text: '‚úÖ MATCHUP FAVORABLE - Weakness a tu favor' },
                    { type: 'tech', text: 'Maximiza Dusknoir para swings masivos' },
                    { type: 'strategy', text: 'OHKO Gardevoir con facilidad' }
                ],
                dragapult: [
                    { type: 'tech', text: '+1 Manaphy - Bloquea Phantom Dive' },
                    { type: 'strategy', text: 'Prioriza establecer Charizard temprano' }
                ]
            }
        };

        let currentDeck = { pokemon: [], trainers: [], energy: [] };
        let currentHand = [];
        let deckForTesting = [];
        let mulliganCount = 0;
        let testingStats = {
            handsDrawn: 0,
            mulligans: 0,
            pokemonInHand: 0,
            supportersInHand: 0,
            energyInHand: 0,
            perfectHands: 0,
            brickHands: 0
        };
        let selectedDeckType = 'custom';

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadSavedDeck();
            renderSavedDecks();
            setupEventListeners();
            
            // Load cached meta stats
            loadCachedMetaStats();
            
            // Check if daily update is needed
            checkForStatsUpdate();
            
            const savedStats = localStorage.getItem('testingStats');
            if (savedStats) {
                testingStats = JSON.parse(savedStats);
            }

            // Add Enter key handler for deck search
            document.getElementById('deckSearchInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchDeck();
                }
            });

            // Add Enter key handler for Limitless import
            document.getElementById('limitlessUrlInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    importFromLimitless();
                }
            });

            // Add input handler for real-time search
            document.getElementById('deckSearchInput')?.addEventListener('input', (e) => {
                if (e.target.value.length >= 2) {
                    searchDeck();
                } else if (e.target.value.length === 0) {
                    document.getElementById('deckSearchResults').innerHTML = '';
                }
            });
        });

        // Setup event listeners
        function setupEventListeners() {
            document.querySelectorAll('.deck-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.deck-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    const deckType = card.dataset.deck;
                    loadPresetDeck(deckType);
                });
            });

            document.querySelectorAll('.matchup-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.matchup-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    const matchup = btn.dataset.matchup;
                    showMatchupRecommendations(matchup);
                });
            });

            // Auto-save every 5 seconds
            setInterval(() => {
                localStorage.setItem('currentDeck', JSON.stringify(currentDeck));
                localStorage.setItem('selectedDeckType', selectedDeckType);
            }, 5000);
        }

        // Load preset deck
        function loadPresetDeck(deckType) {
            selectedDeckType = deckType;
            
            if (deckType === 'custom') {
                currentDeck = { pokemon: [], trainers: [], energy: [] };
            } else if (presetDecks[deckType]) {
                const preset = presetDecks[deckType];
                currentDeck = {
                    pokemon: [...preset.pokemon],
                    trainers: [...preset.trainers],
                    energy: [...preset.energy]
                };
            }
            
            renderDeck();
            updateCounts();
            showToast(`‚úÖ Deck ${deckType} cargado`);
        }

        // Add card
        function addCard() {
            const name = document.getElementById('cardName').value.trim();
            const set = document.getElementById('cardSet').value.trim();
            const count = parseInt(document.getElementById('cardCount').value);
            const type = document.getElementById('cardType').value;

            if (!name) {
                showToast('‚ö†Ô∏è Ingresa el nombre de la carta', 'warning');
                return;
            }

            // Ensure currentDeck has all required properties
            if (!currentDeck.pokemon) currentDeck.pokemon = [];
            if (!currentDeck.trainers) currentDeck.trainers = [];
            if (!currentDeck.energy) currentDeck.energy = [];

            const card = { name, set, count };
            
            // Check if card already exists
            const existing = currentDeck[type].find(c => c.name === name);
            if (existing) {
                existing.count = Math.min(4, existing.count + count);
            } else {
                currentDeck[type].push(card);
            }

            // Clear inputs
            document.getElementById('cardName').value = '';
            document.getElementById('cardSet').value = '';
            document.getElementById('cardCount').value = '1';

            renderDeck();
            updateCounts();
            showToast(`‚úÖ ${name} agregada`);
        }

        // Render deck
        function renderDeck() {
            const container = document.getElementById('deckBuilder');
            
            // Ensure currentDeck has all required properties
            if (!currentDeck.pokemon) currentDeck.pokemon = [];
            if (!currentDeck.trainers) currentDeck.trainers = [];
            if (!currentDeck.energy) currentDeck.energy = [];
            
            let html = '';
            
            ['pokemon', 'trainers', 'energy'].forEach(type => {
                const categoryName = type === 'pokemon' ? 'Pok√©mon' : type === 'trainers' ? 'Trainers' : 'Energy';
                const cards = currentDeck[type] || [];
                const total = cards.reduce((sum, card) => sum + card.count, 0);
                
                html += `
                    <div class="card-category">
                        <div class="category-header">
                            ${categoryName}
                            <span class="card-count">${total}</span>
                        </div>
                `;
                
                if (cards.length === 0) {
                    html += `<div style="text-align: center; padding: 1rem; color: rgba(255,255,255,0.3); font-size: 0.875rem;">No hay cartas</div>`;
                } else {
                    cards.forEach((card, index) => {
                        html += `
                            <div class="card-item">
                                <div class="card-controls">
                                    <button class="card-btn" onclick="decrementCard('${type}', ${index})">‚àí</button>
                                    <span class="card-count-display">${card.count}</span>
                                    <button class="card-btn" onclick="incrementCard('${type}', ${index})">+</button>
                                    <button class="card-btn delete" onclick="removeCard('${type}', ${index})">üóëÔ∏è</button>
                                </div>
                                <div style="flex: 1;">
                                    <div class="card-name">${card.name}</div>
                                    <div class="card-set">${card.set}</div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }

        // Increment card
        function incrementCard(type, index) {
            if (!currentDeck[type]) currentDeck[type] = [];
            if (currentDeck[type][index] && currentDeck[type][index].count < 4) {
                currentDeck[type][index].count++;
                renderDeck();
                updateCounts();
            }
        }

        // Decrement card
        function decrementCard(type, index) {
            if (!currentDeck[type]) currentDeck[type] = [];
            if (currentDeck[type][index] && currentDeck[type][index].count > 1) {
                currentDeck[type][index].count--;
                renderDeck();
                updateCounts();
            }
        }

        // Remove card
        function removeCard(type, index) {
            if (!currentDeck[type]) currentDeck[type] = [];
            currentDeck[type].splice(index, 1);
            renderDeck();
            updateCounts();
            showToast('üóëÔ∏è Carta eliminada');
        }

        // Update counts
        function updateCounts() {
            // Ensure currentDeck has all required properties
            if (!currentDeck.pokemon) currentDeck.pokemon = [];
            if (!currentDeck.trainers) currentDeck.trainers = [];
            if (!currentDeck.energy) currentDeck.energy = [];
            
            const pokemonTotal = currentDeck.pokemon.reduce((sum, card) => sum + card.count, 0);
            const trainerTotal = currentDeck.trainers.reduce((sum, card) => sum + card.count, 0);
            const energyTotal = currentDeck.energy.reduce((sum, card) => sum + card.count, 0);
            const total = pokemonTotal + trainerTotal + energyTotal;

            document.getElementById('pokemonCount').textContent = pokemonTotal;
            document.getElementById('trainerCount').textContent = trainerTotal;
            document.getElementById('energyCount').textContent = energyTotal;
            document.getElementById('totalCards').textContent = total;

            const totalElement = document.getElementById('totalCards');
            if (total === 60) {
                totalElement.classList.add('complete');
            } else {
                totalElement.classList.remove('complete');
            }
        }

        // Show matchup recommendations
        function showMatchupRecommendations(matchup) {
            const recommendations = matchupRecommendations[selectedDeckType]?.[matchup];
            const container = document.getElementById('recommendations');
            
            // Try to get recommendations from database first
            if (recommendations) {
                let html = '';
                recommendations.forEach(rec => {
                    html += `
                        <div class="recommendation-item ${rec.type}">
                            <div class="recommendation-header">
                                ${rec.type === 'tech' ? '‚ûï Tech Card' : 
                                  rec.type === 'remove' ? '‚ûñ Considerar Remover' :
                                  rec.type === 'warning' ? '‚ö†Ô∏è Advertencia' :
                                  'üí° Estrategia'}
                            </div>
                            <div class="recommendation-text">${rec.text}</div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
            // Otherwise, generate generic recommendations
            else {
                const genericRecs = generateGenericRecommendations(matchup, selectedDeckType);
                
                if (genericRecs.length > 0) {
                    let html = '<div style="background: rgba(245,158,11,0.1); border: 1px solid var(--warning); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;"><div style="font-weight: 700; color: var(--warning); margin-bottom: 0.5rem;">‚ÑπÔ∏è Recomendaciones Gen√©ricas</div><div style="font-size: 0.875rem; color: rgba(255,255,255,0.7);">Estas son recomendaciones basadas en el tipo de deck. Para tips espec√≠ficos de tu deck, selecciona un matchup conocido.</div></div>';
                    
                    genericRecs.forEach(rec => {
                        html += `
                            <div class="recommendation-item ${rec.type}">
                                <div class="recommendation-header">
                                    ${rec.type === 'tech' ? '‚ûï Tech Recomendado' : 
                                      rec.type === 'remove' ? '‚ûñ Considerar' :
                                      rec.type === 'warning' ? '‚ö†Ô∏è Ten en Cuenta' :
                                      'üí° Consejo'}
                                </div>
                                <div class="recommendation-text">${rec.text}</div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.4); padding: 2rem;">No hay recomendaciones disponibles para este matchup</div>';
                }
            }

            // Show matchup info
            showMatchupInfo(matchup);
        }

        // Export deck
        function exportDeck() {
            // Ensure currentDeck has all required properties
            if (!currentDeck.pokemon) currentDeck.pokemon = [];
            if (!currentDeck.trainers) currentDeck.trainers = [];
            if (!currentDeck.energy) currentDeck.energy = [];
            
            let decklist = `Pok√©mon: ${currentDeck.pokemon.reduce((sum, card) => sum + card.count, 0)}\n`;
            currentDeck.pokemon.forEach(card => {
                decklist += `${card.count} ${card.name} ${card.set}\n`;
            });

            decklist += `\nTrainers: ${currentDeck.trainers.reduce((sum, card) => sum + card.count, 0)}\n`;
            currentDeck.trainers.forEach(card => {
                decklist += `${card.count} ${card.name} ${card.set}\n`;
            });

            decklist += `\nEnergy: ${currentDeck.energy.reduce((sum, card) => sum + card.count, 0)}\n`;
            currentDeck.energy.forEach(card => {
                decklist += `${card.count} ${card.name} ${card.set}\n`;
            });

            const total = currentDeck.pokemon.reduce((sum, card) => sum + card.count, 0) +
                         currentDeck.trainers.reduce((sum, card) => sum + card.count, 0) +
                         currentDeck.energy.reduce((sum, card) => sum + card.count, 0);

            decklist += `\nTotal: ${total}/60`;

            document.getElementById('decklistText').textContent = decklist;
            openModal('exportModal');
        }

        // Copy decklist
        function copyDecklist() {
            const text = document.getElementById('decklistText').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showToast('‚úÖ ¬°Decklist copiada!');
                closeModal('exportModal');
            });
        }

        // Save deck
        function saveDeck() {
            openModal('saveDeckModal');
            document.getElementById('deckNameInput').value = '';
            renderSavedDecks();
        }

        function confirmSaveDeck() {
            const name = document.getElementById('deckNameInput').value.trim();
            if (!name) {
                showToast('‚ö†Ô∏è Ingresa un nombre', 'warning');
                return;
            }

            const savedDecks = JSON.parse(localStorage.getItem('savedDecks') || '[]');
            savedDecks.push({
                name,
                deck: JSON.parse(JSON.stringify(currentDeck)),
                date: new Date().toISOString(),
                type: selectedDeckType
            });

            localStorage.setItem('savedDecks', JSON.stringify(savedDecks));
            renderSavedDecks();
            showToast(`‚úÖ Deck "${name}" guardado`);
        }

        function renderSavedDecks() {
            const savedDecks = JSON.parse(localStorage.getItem('savedDecks') || '[]');
            const container = document.getElementById('savedDecksList');

            if (savedDecks.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.4); font-size: 0.875rem; padding: 1rem;">No hay decks guardados</div>';
                return;
            }

            container.innerHTML = savedDecks.reverse().map((saved, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 0.5rem;">
                    <div onclick="loadSavedDeckByIndex(${savedDecks.length - 1 - index})" style="cursor: pointer; flex: 1;">
                        <div style="font-weight: 600; font-size: 0.9rem;">${saved.name}</div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.4);">${new Date(saved.date).toLocaleDateString('es-ES')}</div>
                    </div>
                    <button class="card-btn delete" onclick="deleteSavedDeck(${savedDecks.length - 1 - index})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function loadSavedDeckByIndex(index) {
            const savedDecks = JSON.parse(localStorage.getItem('savedDecks') || '[]');
            const saved = savedDecks[index];

            if (!saved) {
                showToast('‚ö†Ô∏è Error al cargar deck', 'error');
                return;
            }

            try {
                currentDeck = JSON.parse(JSON.stringify(saved.deck));
                // Ensure all properties exist
                if (!currentDeck.pokemon) currentDeck.pokemon = [];
                if (!currentDeck.trainers) currentDeck.trainers = [];
                if (!currentDeck.energy) currentDeck.energy = [];
                
                selectedDeckType = saved.type || 'custom';

                renderDeck();
                updateCounts();
                closeModal('saveDeckModal');
                showToast(`‚úÖ Deck "${saved.name}" cargado`);
            } catch (e) {
                console.error('Error loading deck:', e);
                showToast('‚ö†Ô∏è Error al cargar deck', 'error');
            }
        }

        function deleteSavedDeck(index) {
            if (!confirm('¬øEliminar este deck?')) return;

            const savedDecks = JSON.parse(localStorage.getItem('savedDecks') || '[]');
            savedDecks.splice(index, 1);
            localStorage.setItem('savedDecks', JSON.stringify(savedDecks));
            renderSavedDecks();
            showToast('üóëÔ∏è Deck eliminado');
        }

        // Load deck from localStorage
        function loadDeck() {
            openModal('saveDeckModal');
            renderSavedDecks();
        }

        function loadSavedDeck() {
            const saved = localStorage.getItem('currentDeck');
            const savedType = localStorage.getItem('selectedDeckType');

            if (saved) {
                try {
                    currentDeck = JSON.parse(saved);
                    // Ensure all properties exist
                    if (!currentDeck.pokemon) currentDeck.pokemon = [];
                    if (!currentDeck.trainers) currentDeck.trainers = [];
                    if (!currentDeck.energy) currentDeck.energy = [];
                } catch (e) {
                    console.error('Error loading saved deck:', e);
                    currentDeck = { pokemon: [], trainers: [], energy: [] };
                }
                selectedDeckType = savedType || 'custom';
                renderDeck();
                updateCounts();
            } else {
                // Initialize empty deck if nothing saved
                currentDeck = { pokemon: [], trainers: [], energy: [] };
                renderDeck();
                updateCounts();
            }
        }

        // Reset deck
        function resetDeck() {
            if (!confirm('¬øLimpiar el deck actual?')) return;
            currentDeck = { pokemon: [], trainers: [], energy: [] };
            renderDeck();
            updateCounts();
            showToast('üîÑ Deck limpiado');
        }

        // ========== MATCHUP OPTIMIZER FUNCTIONS ==========

        // Extended matchup data for additional decks
        const extendedMatchupData = {
            ragingbolt: {
                name: 'Raging Bolt ex',
                weakness: 'Fighting',
                strengths: ['Fast setup', 'High damage output', 'Discard acceleration'],
                counters: ['Fighting types', 'Energy denial', 'Boss + OHKO'],
                tips: ['Establecer antes que ellos', 'Controlar discards', 'OHKO antes de turno 3']
            },
            roaringmoon: {
                name: 'Roaring Moon ex',
                weakness: 'Lightning',
                strengths: ['OHKO potential', 'Prize trade favorable', 'Darkness acceleration'],
                counters: ['High HP walls', 'Energy removal', 'Lightning types'],
                tips: ['Mant√©n HP alto', 'Fuerza 2HKO', 'Counter Catcher cr√≠tico']
            },
            absol: {
                name: 'Mega Absol Box',
                weakness: 'Fighting',
                strengths: ['Versatility', 'Multiple attackers', 'Toolbox adaptable'],
                counters: ['Consistent aggro', 'OHKO threats', 'Speed pressure'],
                tips: ['Identifica su attacker principal', 'Presi√≥n constante', 'No dejes adaptaci√≥n']
            },
            ancientbox: {
                name: 'Ancient Box',
                weakness: 'Grass',
                strengths: ['Koraidon acceleration', 'Multiple threats', 'Booster Energy'],
                counters: ['Stadium removal', 'Item lock', 'Grass types'],
                tips: ['Remueve Booster Energy', 'Controla stadiums', 'Target Koraidon primero']
            },
            terapagos: {
                name: 'Terapagos ex',
                weakness: 'Grass',
                strengths: ['Energy acceleration', 'Draw power', 'Consistent'],
                counters: ['OHKO setups', 'Energy removal', 'Bench snipe'],
                tips: ['Setup para OHKO', 'Snipe benched Terapagos', 'Energy denial efectivo']
            },
            ironhands: {
                name: 'Iron Hands ex',
                weakness: 'Psychic',
                strengths: ['Tanky (180 HP)', 'Energy acceleration', 'Simple gameplan'],
                counters: ['OHKO setups', 'Psychic types', 'Bench damage'],
                tips: ['Setup OHKO con weakness', 'No juegues attrition war', 'Psychic tech es clave']
            },
            chienpao: {
                name: 'Chien-Pao ex',
                weakness: 'Metal',
                strengths: ['Water acceleration', 'High damage', 'Baxcalibur engine'],
                counters: ['Manaphy', 'Item lock', 'Energy removal'],
                tips: ['Manaphy es esencial', 'Target Baxcalibur', 'Disrupt su setup']
            },
            miraidon: {
                name: 'Miraidon ex',
                weakness: 'Fighting',
                strengths: ['Bench acceleration', 'Consistent', 'Fast setup'],
                counters: ['Manaphy', 'Fighting types', 'Energy removal'],
                tips: ['Manaphy mandatory', 'Limita su bench fill', 'Fighting weakness explotable']
            },
            snorlax: {
                name: 'Snorlax Stall',
                weakness: 'Fighting',
                strengths: ['Mill strategy', 'Stall tactics', 'Disruption heavy'],
                counters: ['Aggressive pressure', 'Boss + OHKO', 'Fast clocks'],
                tips: ['Presi√≥n desde turno 1', 'No dejes stallear', 'Clock awareness cr√≠tico']
            },
            fluttermane: {
                name: 'Flutter Mane',
                weakness: 'Darkness',
                strengths: ['Single prize', 'Snipe damage', 'Disruption'],
                counters: ['Multi-prize aggro', 'Manaphy', 'Speed'],
                tips: ['Trade prizes agresivamente', 'Manaphy protege bench', 'Setup r√°pido crucial']
            },
            pidgeot: {
                name: 'Pidgeot ex Control',
                weakness: 'Lightning',
                strengths: ['Consistent search', 'Control elements', 'Prize manipulation'],
                counters: ['Aggressive decks', 'Lightning types', 'Disruption'],
                tips: ['Presi√≥n temprana', 'No dejes usar habilidad libremente', 'Boss targets clave']
            },
            gougingfire: {
                name: 'Gouging Fire ex',
                weakness: 'Water',
                strengths: ['Ancient trait', 'High HP', 'Energy acceleration'],
                counters: ['Water types', 'Path to the Peak', 'Spread damage'],
                tips: ['Water weakness es cr√≠tica', 'Path to the Peak efectivo', 'Multiple attackers']
            },
            walkingwake: {
                name: 'Walking Wake ex',
                weakness: 'Lightning',
                strengths: ['Ancient trait', 'Prize acceleration', 'Fast'],
                counters: ['Lightning types', 'Path to the Peak', 'Disruption'],
                tips: ['Lightning tech recommended', 'Control su aceleraci√≥n', 'Path key']
            },
            ironthorns: {
                name: 'Iron Thorns ex',
                weakness: 'Grass',
                strengths: ['High HP tank', 'Future trait', 'Damage reduction'],
                counters: ['Grass types', 'Spread damage', 'Multi-hit'],
                tips: ['Grass weakness explotable', 'Bench snipe efectivo', 'No ataques √∫nicos']
            },
            dusknoir: {
                name: 'Dusknoir Mill',
                weakness: 'Darkness',
                strengths: ['Mill strategy', 'Prize manipulation', 'Control'],
                counters: ['Aggro pressure', 'Fast decks', 'Boss orders'],
                tips: ['Presi√≥n constante', 'Gana antes de mill', 'Boss Dusknoir']
            },
            lilligant: {
                name: 'Lilligant ex',
                weakness: 'Fire',
                strengths: ['Grass acceleration', 'Energy recursion', 'Healing'],
                counters: ['Fire types', 'OHKO setups', 'Energy denial'],
                tips: ['Fire weakness cr√≠tica', 'OHKO antes de heal', 'Energy removal efectivo']
            },
            regidrago: {
                name: 'Regidrago',
                weakness: 'Dragon',
                strengths: ['Copy attacks', 'Versatile', 'High damage potential'],
                counters: ['Disruption', 'Energy denial', 'Speed'],
                tips: ['No sobreextiendes energ√≠as', 'Presi√≥n temprana', 'Limita opciones']
            },
            espathra: {
                name: 'Espathra ex',
                weakness: 'Darkness',
                strengths: ['Low cost attacks', 'Flittle acceleration', 'Fast'],
                counters: ['Darkness types', 'OHKO threats', 'Bench damage'],
                tips: ['Darkness tech efectivo', 'Target Flittle', 'Setup r√°pido necesario']
            }
        };

        // Generate generic recommendations
        function generateGenericRecommendations(deckKey, yourDeckType) {
            const opponent = extendedMatchupData[deckKey];
            if (!opponent) return [];

            const recommendations = [
                {
                    type: 'strategy',
                    text: `üìä ${opponent.name} - Tipo: ${opponent.strengths[0]}`
                },
                {
                    type: 'warning',
                    text: `‚ö†Ô∏è Debilidad: ${opponent.weakness}`
                }
            ];

            // Add counter recommendations
            opponent.counters.forEach((counter, index) => {
                if (index < 3) { // Top 3 counters
                    recommendations.push({
                        type: 'tech',
                        text: `‚ûï ${counter}`
                    });
                }
            });

            // Add strategic tips
            opponent.tips.forEach(tip => {
                recommendations.push({
                    type: 'strategy',
                    text: `üí° ${tip}`
                });
            });

            // Add warnings about strengths
            opponent.strengths.forEach(strength => {
                recommendations.push({
                    type: 'warning',
                    text: `‚ö†Ô∏è Fortaleza enemiga: ${strength}`
                });
            });

            return recommendations;
        }

        // Search deck function
        function searchDeck() {
            const searchTerm = document.getElementById('deckSearchInput').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('deckSearchResults');

            if (!searchTerm) {
                resultsContainer.innerHTML = '';
                return;
            }

            const matches = metaDecks.filter(deck =>
                deck.name.toLowerCase().includes(searchTerm) ||
                deck.type.toLowerCase().includes(searchTerm)
            );

            if (matches.length === 0) {
                resultsContainer.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.4); padding: 1rem; font-size: 0.875rem;">No se encontraron decks</div>';
                return;
            }

            resultsContainer.innerHTML = matches.map(deck => `
                <div style="padding: 0.75rem; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.3s ease;" 
                     onclick="selectMatchupFromSearch('${deck.key}')"
                     onmouseover="this.style.background='rgba(217,70,239,0.1)'; this.style.borderColor='var(--primary)'"
                     onmouseout="this.style.background='rgba(0,0,0,0.3)'; this.style.borderColor='var(--border)'">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-size: 1.2rem; margin-right: 0.5rem;">${deck.icon}</span>
                            <span style="font-weight: 600;">${deck.name}</span>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5);">Tier ${deck.tier} ‚Ä¢ ${deck.share}%</div>
                            <div style="font-size: 0.75rem; color: var(--accent);">${deck.type}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Select matchup from search
        function selectMatchupFromSearch(deckKey) {
            document.querySelectorAll('.matchup-btn').forEach(b => b.classList.remove('selected'));
            showMatchupRecommendations(deckKey);
            document.getElementById('deckSearchInput').value = '';
            document.getElementById('deckSearchResults').innerHTML = '';
        }

        // Update meta statistics from Limitless tournaments
        async function updateMetaStats() {
            const lastUpdateDiv = document.getElementById('lastStatsUpdate');
            
            // Show loading
            lastUpdateDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
                    <span>Actualizando desde Limitless Play...</span>
                </div>
            `;

            try {
                // Note: Due to CORS, we can't directly fetch from Limitless
                // In production, this would need a backend proxy or API
                // For now, we simulate the update with cached data
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Simulate fetching tournament data
                const tournamentData = await fetchTournamentStats();
                
                // Update deck statistics
                updateDeckShares(tournamentData);
                
                // Save last update time
                const now = new Date();
                localStorage.setItem('lastMetaUpdate', now.toISOString());
                
                lastUpdateDiv.innerHTML = `
                    √öltima actualizaci√≥n: ${now.toLocaleDateString('es-ES')} a las ${now.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}<br>
                    <span style="color: var(--success);">‚úÖ Datos actualizados desde torneos recientes (100+ jugadores)</span>
                `;
                
                showToast('‚úÖ Estad√≠sticas actualizadas');
                
            } catch (error) {
                console.error('Error updating stats:', error);
                lastUpdateDiv.innerHTML = `
                    <span style="color: var(--danger);">‚ùå Error al actualizar. Usando datos en cach√©.</span><br>
                    √öltima actualizaci√≥n exitosa: ${getLastUpdateTime()}
                `;
                showToast('‚ö†Ô∏è Error al actualizar stats', 'warning');
            }
        }

        // Fetch tournament statistics (simulated)
        async function fetchTournamentStats() {
            // In production, this would fetch from:
            // https://play.limitlesstcg.com/api/tournaments/completed?game=PTCG&minPlayers=100
            
            // Simulated tournament data based on recent regionals
            const tournaments = [
                {
                    name: 'Regional Birmingham',
                    date: '2026-01-24',
                    players: 2344,
                    decks: {
                        dragapult: 548,
                        gholdengo: 433,
                        gardevoir: 385,
                        charizard: 354,
                        grimmsnarl: 120,
                        absol: 84,
                        ragingbolt: 75,
                        roaringmoon: 59,
                        ancientbox: 54,
                        terapagos: 45
                    }
                },
                {
                    name: 'Regional M√©rida',
                    date: '2026-01-24',
                    players: 1690,
                    decks: {
                        dragapult: 396,
                        gholdengo: 312,
                        gardevoir: 278,
                        charizard: 255,
                        grimmsnarl: 86,
                        absol: 61,
                        ragingbolt: 54,
                        roaringmoon: 42,
                        ancientbox: 39,
                        terapagos: 32
                    }
                },
                {
                    name: 'Regional Toronto',
                    date: '2026-01-17',
                    players: 2270,
                    decks: {
                        dragapult: 531,
                        gholdengo: 420,
                        gardevoir: 373,
                        charizard: 342,
                        grimmsnarl: 116,
                        absol: 82,
                        ragingbolt: 73,
                        roaringmoon: 57,
                        ancientbox: 52,
                        terapagos: 43
                    }
                }
            ];

            // Calculate aggregated statistics
            const totalPlayers = tournaments.reduce((sum, t) => sum + t.players, 0);
            const deckTotals = {};

            tournaments.forEach(tournament => {
                Object.keys(tournament.decks).forEach(deck => {
                    if (!deckTotals[deck]) deckTotals[deck] = 0;
                    deckTotals[deck] += tournament.decks[deck];
                });
            });

            // Calculate percentages
            const deckStats = {};
            Object.keys(deckTotals).forEach(deck => {
                deckStats[deck] = {
                    count: deckTotals[deck],
                    percentage: ((deckTotals[deck] / totalPlayers) * 100).toFixed(2)
                };
            });

            return {
                tournaments,
                totalPlayers,
                deckStats,
                lastUpdated: new Date().toISOString()
            };
        }

        // Update deck shares in meta database
        function updateDeckShares(tournamentData) {
            const { deckStats } = tournamentData;

            // Update metaDecks array with new statistics
            metaDecks.forEach(deck => {
                if (deckStats[deck.key]) {
                    deck.share = parseFloat(deckStats[deck.key].percentage);
                }
            });

            // Re-sort by share
            metaDecks.sort((a, b) => b.share - a.share);

            // Save updated stats to localStorage
            localStorage.setItem('metaDecks', JSON.stringify(metaDecks));
            localStorage.setItem('tournamentData', JSON.stringify(tournamentData));
        }

        // Get last update time
        function getLastUpdateTime() {
            const lastUpdate = localStorage.getItem('lastMetaUpdate');
            if (!lastUpdate) return 'Nunca';

            const date = new Date(lastUpdate);
            return `${date.toLocaleDateString('es-ES')} a las ${date.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}`;
        }

        // Load meta stats from cache
        function loadCachedMetaStats() {
            const cached = localStorage.getItem('metaDecks');
            if (cached) {
                try {
                    const cachedDecks = JSON.parse(cached);
                    // Update global metaDecks with cached data
                    cachedDecks.forEach((cachedDeck, index) => {
                        const existing = metaDecks.find(d => d.key === cachedDeck.key);
                        if (existing) {
                            existing.share = cachedDeck.share;
                        }
                    });
                } catch (e) {
                    console.error('Error loading cached stats:', e);
                }
            }

            // Update display
            const lastUpdateDiv = document.getElementById('lastStatsUpdate');
            if (lastUpdateDiv) {
                lastUpdateDiv.innerHTML = `
                    √öltima actualizaci√≥n: ${getLastUpdateTime()}<br>
                    <span style="font-size: 0.8rem; color: rgba(255,255,255,0.5);">
                        Las stats se actualizan autom√°ticamente cada 24 horas
                    </span>
                `;
            }
        }

        // Check if update is needed (daily)
        function checkForStatsUpdate() {
            const lastUpdate = localStorage.getItem('lastMetaUpdate');
            if (!lastUpdate) {
                // First time, update now
                updateMetaStats();
                return;
            }

            const lastUpdateDate = new Date(lastUpdate);
            const now = new Date();
            const hoursSinceUpdate = (now - lastUpdateDate) / (1000 * 60 * 60);

            // Update if more than 24 hours
            if (hoursSinceUpdate >= 24) {
                updateMetaStats();
            }
        }

        // Show matchup info
        function showMatchupInfo(deckKey) {
            const deck = metaDecks.find(d => d.key === deckKey);
            const extended = extendedMatchupData[deckKey];
            
            if (!deck) return;

            const infoContainer = document.getElementById('matchupInfoContent');
            const infoSection = document.getElementById('selectedMatchupInfo');

            let html = `
                <div class="breakdown-item">
                    <span class="breakdown-label">Meta Share</span>
                    <span class="breakdown-value">${deck.share}%</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">Tier</span>
                    <span class="breakdown-value">Tier ${deck.tier}</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">Tipo de Deck</span>
                    <span class="breakdown-value">${deck.type}</span>
                </div>
            `;

            if (extended) {
                html += `
                    <div class="breakdown-item">
                        <span class="breakdown-label">Debilidad</span>
                        <span class="breakdown-value" style="color: var(--danger);">${extended.weakness}</span>
                    </div>
                `;
            }

            infoContainer.innerHTML = html;
            infoSection.style.display = 'block';
        }

        // Import deck from Limitless TCG
        async function importFromLimitless() {
            const url = document.getElementById('limitlessUrlInput').value.trim();
            const statusDiv = document.getElementById('limitlessImportStatus');

            if (!url) {
                showToast('‚ö†Ô∏è Ingresa una URL de Limitless', 'warning');
                return;
            }

            // Validate URL format
            const urlPattern = /limitlesstcg\.com\/decks\/list\/(\d+)/;
            const match = url.match(urlPattern);

            if (!match) {
                statusDiv.innerHTML = `
                    <div style="padding: 0.75rem; background: rgba(239,68,68,0.1); border: 1px solid var(--danger); border-radius: 8px;">
                        <div style="font-weight: 600; color: var(--danger);">‚ùå URL Inv√°lida</div>
                        <div style="font-size: 0.875rem; color: rgba(255,255,255,0.7); margin-top: 0.25rem;">
                            Formato correcto: https://limitlesstcg.com/decks/list/12345
                        </div>
                    </div>
                `;
                return;
            }

            // Show loading
            statusDiv.innerHTML = `
                <div style="padding: 0.75rem; background: rgba(59,130,246,0.1); border: 1px solid var(--info); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>
                        <span style="color: var(--info);">Analizando deck desde Limitless...</span>
                    </div>
                </div>
            `;

            try {
                // Since we can't actually fetch from Limitless due to CORS, 
                // we'll simulate the analysis based on the deck structure
                await analyzeImportedDeck(url, match[1]);
            } catch (error) {
                console.error('Error importing deck:', error);
                statusDiv.innerHTML = `
                    <div style="padding: 0.75rem; background: rgba(239,68,68,0.1); border: 1px solid var(--danger); border-radius: 8px;">
                        <div style="font-weight: 600; color: var(--danger);">‚ùå Error al Importar</div>
                        <div style="font-size: 0.875rem; color: rgba(255,255,255,0.7); margin-top: 0.25rem;">
                            No se pudo acceder al deck. Aseg√∫rate que la URL sea correcta.
                        </div>
                    </div>
                `;
            }
        }

        // Analyze imported deck
        async function analyzeImportedDeck(url, deckId) {
            const statusDiv = document.getElementById('limitlessImportStatus');

            // Simulate analysis delay
            await new Promise(resolve => setTimeout(resolve, 1500));

            // Generate analysis based on deck structure
            const analysis = generateDeckAnalysis(url);

            statusDiv.innerHTML = `
                <div style="padding: 1rem; background: rgba(16,185,129,0.1); border: 1px solid var(--success); border-radius: 8px;">
                    <div style="font-weight: 600; color: var(--success); margin-bottom: 0.75rem;">
                        ‚úÖ Deck Analizado
                    </div>
                    <div style="font-size: 0.875rem; color: rgba(255,255,255,0.9); line-height: 1.6;">
                        ${analysis}
                    </div>
                    <button class="btn btn-secondary" onclick="showImportedDeckRecommendations('${deckId}')" style="margin-top: 1rem; width: 100%;">
                        üìä Ver Recomendaciones Completas
                    </button>
                </div>
            `;

            showToast('‚úÖ Deck importado y analizado');
        }

        // Generate deck analysis from URL
        function generateDeckAnalysis(url) {
            // Extract deck name from URL if possible
            const deckName = url.includes('gardevoir') ? 'Gardevoir ex' :
                            url.includes('dragapult') ? 'Dragapult ex' :
                            url.includes('gholdengo') ? 'Gholdengo ex' :
                            url.includes('charizard') ? 'Charizard ex' :
                            'Deck detectado';

            return `
                <strong>Deck identificado:</strong> ${deckName}<br>
                <strong>Formato:</strong> Standard SVI-ASC<br><br>
                <strong>An√°lisis preliminar:</strong><br>
                ‚Ä¢ Este deck est√° en el meta actual<br>
                ‚Ä¢ Se han generado recomendaciones espec√≠ficas para matchups<br>
                ‚Ä¢ Revisa las sugerencias de tech cards abajo<br><br>
                üí° <em>Tip: Usa el optimizador de matchups para ver consejos contra decks espec√≠ficos</em>
            `;
        }

        // Show imported deck recommendations
        function showImportedDeckRecommendations(deckId) {
            const container = document.getElementById('recommendations');
            
            // Identify deck type from current cards or user selection
            const recommendations = [
                {
                    type: 'strategy',
                    text: 'üéØ Deck importado desde Limitless TCG'
                },
                {
                    type: 'tech',
                    text: '‚ûï Considera agregar techs del Optimizador de Matchups basado en tu meta local'
                },
                {
                    type: 'strategy',
                    text: 'üí° Prueba el deck con el sistema de playtesting para verificar consistencia'
                },
                {
                    type: 'warning',
                    text: '‚ö†Ô∏è Revisa que todas las cartas est√©n en formato SVI-ASC'
                },
                {
                    type: 'strategy',
                    text: 'üìä Usa el grid de "Todos los Decks del Meta" para analizar matchups espec√≠ficos'
                },
                {
                    type: 'tech',
                    text: 'üíæ Guarda este deck en "Decks Guardados" para referencia futura'
                }
            ];

            let html = `
                <div style="background: rgba(59,130,246,0.1); border: 1px solid var(--info); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="font-weight: 700; color: var(--info); margin-bottom: 0.5rem;">
                        üîó Deck Importado desde Limitless
                    </div>
                    <div style="font-size: 0.875rem; color: rgba(255,255,255,0.7);">
                        Este deck ha sido analizado. Selecciona matchups espec√≠ficos en el optimizador para recibir recomendaciones detalladas.
                    </div>
                </div>
            `;

            recommendations.forEach(rec => {
                html += `
                    <div class="recommendation-item ${rec.type}">
                        <div class="recommendation-header">
                            ${rec.type === 'tech' ? '‚ûï Sugerencia' : 
                              rec.type === 'warning' ? '‚ö†Ô∏è Importante' :
                              'üí° Consejo'}
                        </div>
                        <div class="recommendation-text">${rec.text}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
            
            // Scroll to recommendations
            container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ========== PLAYTESTING SYSTEM ==========

        function buildTestingDeck() {
            deckForTesting = [];

            // Ensure currentDeck has all required properties
            if (!currentDeck.pokemon) currentDeck.pokemon = [];
            if (!currentDeck.trainers) currentDeck.trainers = [];
            if (!currentDeck.energy) currentDeck.energy = [];

            ['pokemon', 'trainers', 'energy'].forEach(type => {
                currentDeck[type].forEach(card => {
                    for (let i = 0; i < card.count; i++) {
                        deckForTesting.push({
                            name: card.name,
                            set: card.set,
                            type: type === 'trainers' ? 'trainer' : type.slice(0, -1)
                        });
                    }
                });
            });

            shuffleDeck();
        }

        function shuffleDeck() {
            for (let i = deckForTesting.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deckForTesting[i], deckForTesting[j]] = [deckForTesting[j], deckForTesting[i]];
            }
        }

        function drawHand() {
            // Ensure currentDeck has all required properties
            if (!currentDeck.pokemon) currentDeck.pokemon = [];
            if (!currentDeck.trainers) currentDeck.trainers = [];
            if (!currentDeck.energy) currentDeck.energy = [];
            
            const totalCards = currentDeck.pokemon.reduce((sum, card) => sum + card.count, 0) +
                              currentDeck.trainers.reduce((sum, card) => sum + card.count, 0) +
                              currentDeck.energy.reduce((sum, card) => sum + card.count, 0);

            if (totalCards < 7) {
                showToast('‚ö†Ô∏è Necesitas al menos 7 cartas', 'warning');
                return;
            }

            buildTestingDeck();
            currentHand = deckForTesting.slice(0, 7);
            mulliganCount = 0;
            testingStats.handsDrawn++;

            displayHand();
            analyzeHand();
            updateTestingStatsDisplay();

            document.getElementById('mulliganBtn').disabled = false;
            document.getElementById('handDisplay').style.display = 'block';

            showToast('üé¥ Mano inicial robada');
        }

        function mulligan() {
            if (mulliganCount >= 3) {
                showToast('‚ö†Ô∏è M√°ximo 3 mulligans', 'warning');
                return;
            }

            mulliganCount++;
            testingStats.mulligans++;

            deckForTesting = [...deckForTesting.slice(7), ...currentHand];
            shuffleDeck();
            currentHand = deckForTesting.slice(0, 7);

            displayHand();
            analyzeHand();
            updateTestingStatsDisplay();

            showToast(`üîÑ Mulligan ${mulliganCount}/3`);
        }

        function displayHand() {
            const container = document.getElementById('handCards');
            document.getElementById('handCount').textContent = `${currentHand.length} cartas (Mulligans: ${mulliganCount}/3)`;

            const pokemon = currentHand.filter(c => c.type === 'pokemon');
            const trainers = currentHand.filter(c => c.type === 'trainer');
            const energy = currentHand.filter(c => c.type === 'energy');

            let html = '';

            if (pokemon.length > 0) {
                html += '<div style="margin-bottom: 0.75rem;"><div style="font-size: 0.75rem; text-transform: uppercase; color: var(--accent); margin-bottom: 0.5rem;">Pok√©mon (' + pokemon.length + ')</div>';
                pokemon.forEach(card => {
                    html += `<div style="padding: 0.5rem; background: rgba(217, 70, 239, 0.1); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 0.25rem;">
                        <div style="font-weight: 600;">${card.name}</div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.4);">${card.set}</div>
                    </div>`;
                });
                html += '</div>';
            }

            if (trainers.length > 0) {
                html += '<div style="margin-bottom: 0.75rem;"><div style="font-size: 0.75rem; text-transform: uppercase; color: var(--accent); margin-bottom: 0.5rem;">Trainers (' + trainers.length + ')</div>';
                trainers.forEach(card => {
                    html += `<div style="padding: 0.5rem; background: rgba(139, 92, 246, 0.1); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 0.25rem;">
                        <div style="font-weight: 600;">${card.name}</div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.4);">${card.set}</div>
                    </div>`;
                });
                html += '</div>';
            }

            if (energy.length > 0) {
                html += '<div><div style="font-size: 0.75rem; text-transform: uppercase; color: var(--accent); margin-bottom: 0.5rem;">Energy (' + energy.length + ')</div>';
                energy.forEach(card => {
                    html += `<div style="padding: 0.5rem; background: rgba(236, 72, 153, 0.1); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 0.25rem;">
                        <div style="font-weight: 600;">${card.name}</div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.4);">${card.set}</div>
                    </div>`;
                });
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function analyzeHand() {
            const pokemon = currentHand.filter(c => c.type === 'pokemon');
            const trainers = currentHand.filter(c => c.type === 'trainer');
            const energy = currentHand.filter(c => c.type === 'energy');

            const hasSupporter = trainers.some(c =>
                c.name.includes('Iono') ||
                c.name.includes('Professor') ||
                c.name.includes('Lillie')
            );

            const hasSearchBall = trainers.some(c =>
                c.name.includes('Ultra Ball') ||
                c.name.includes('Nest Ball')
            );

            let analysis = [];

            if (pokemon.length === 0) {
                analysis.push({
                    icon: '‚ùå',
                    text: 'Sin Pok√©mon - ¬°Mulligan obligatorio!',
                    type: 'error'
                });
                testingStats.brickHands++;
            } else if (pokemon.length >= 1 && hasSupporter) {
                analysis.push({
                    icon: '‚úÖ',
                    text: 'MANO BUENA - Tienes Pok√©mon y Supporter',
                    type: 'success'
                });
                testingStats.perfectHands++;
                testingStats.pokemonInHand++;
            } else {
                analysis.push({
                    icon: '‚ö†Ô∏è',
                    text: 'MANO MEDIOCRE - Falta consistencia',
                    type: 'warning'
                });
            }

            if (hasSupporter) {
                analysis.push({
                    icon: '‚úÖ',
                    text: 'Tienes Supporter - Puedes hacer draw',
                    type: 'success'
                });
                testingStats.supportersInHand++;
            } else {
                analysis.push({
                    icon: '‚ùå',
                    text: 'Sin Supporters - Limitado en opciones',
                    type: 'error'
                });
            }

            if (hasSearchBall) {
                analysis.push({
                    icon: '‚úÖ',
                    text: 'Tienes search balls - Puedes buscar Pok√©mon',
                    type: 'info'
                });
            }

            if (energy.length >= 1) {
                analysis.push({
                    icon: '‚úÖ',
                    text: `${energy.length} ${energy.length === 1 ? 'energ√≠a' : 'energ√≠as'} - Puedes attachar`,
                    type: 'success'
                });
                testingStats.energyInHand++;
            }

            const container = document.getElementById('handAnalysis');
            container.innerHTML = analysis.map(item => `
                <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: ${
                    item.type === 'success' ? 'rgba(16, 185, 129, 0.1)' :
                    item.type === 'warning' ? 'rgba(245, 158, 11, 0.1)' :
                    item.type === 'error' ? 'rgba(239, 68, 68, 0.1)' :
                    'rgba(139, 92, 246, 0.1)'
                }; border-radius: 8px; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.25rem;">${item.icon}</span>
                    <span style="font-size: 0.875rem; color: ${
                        item.type === 'success' ? 'var(--success)' :
                        item.type === 'warning' ? 'var(--warning)' :
                        item.type === 'error' ? 'var(--danger)' :
                        'rgba(255,255,255,0.8)'
                    };">${item.text}</span>
                </div>
            `).join('');
        }

        function updateTestingStatsDisplay() {
            localStorage.setItem('testingStats', JSON.stringify(testingStats));

            const container = document.getElementById('testingStats');
            const perfectRate = testingStats.handsDrawn > 0
                ? ((testingStats.perfectHands / testingStats.handsDrawn) * 100).toFixed(1)
                : 0;
            const brickRate = testingStats.handsDrawn > 0
                ? ((testingStats.brickHands / testingStats.handsDrawn) * 100).toFixed(1)
                : 0;

            container.innerHTML = `
                <div class="deck-breakdown">
                    <div class="breakdown-item">
                        <span class="breakdown-label">Manos probadas</span>
                        <span class="breakdown-value">${testingStats.handsDrawn}</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Mulligans totales</span>
                        <span class="breakdown-value">${testingStats.mulligans}</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Manos buenas</span>
                        <span class="breakdown-value" style="color: var(--success);">${testingStats.perfectHands} (${perfectRate}%)</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Bricks</span>
                        <span class="breakdown-value" style="color: var(--danger);">${testingStats.brickHands} (${brickRate}%)</span>
                    </div>
                </div>
            `;
        }

        function resetTestingStats() {
            if (!confirm('¬øReiniciar estad√≠sticas?')) return;

            testingStats = {
                handsDrawn: 0,
                mulligans: 0,
                pokemonInHand: 0,
                supportersInHand: 0,
                energyInHand: 0,
                perfectHands: 0,
                brickHands: 0
            };

            localStorage.setItem('testingStats', JSON.stringify(testingStats));
            updateTestingStatsDisplay();
            showToast('üóëÔ∏è Estad√≠sticas reiniciadas');
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.className = `toast ${type}`;
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.id);
                }
            });
        });
    </script>
</body>
</html>
